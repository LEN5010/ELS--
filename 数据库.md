# 系统定义
系统名称：英语学习系统  
系统目标：为学习者提供词汇、语法、听力学习与练习功能，同时支持学习进度跟踪、讨论区互动及后台管理。

```sql
  -- 登录信息表
  CREATE TABLE user_auth (
      user_id     INT AUTO_INCREMENT PRIMARY KEY,  
      email       VARCHAR(120) NOT NULL UNIQUE,
      pwd_hash    CHAR(64) NOT NULL,                 -- 密码哈希值，使用SHA256加密
      salt        CHAR(16) NOT NULL,                 -- 盐值，用于密码加密，固定16字节
      created_at  DATETIME DEFAULT CURRENT_TIMESTAMP 
  );

  -- 基本信息表
  CREATE TABLE user_profile (
      user_id     INT PRIMARY KEY,                  -- 用户ID主键，外键关联到user_auth表
      nickname    VARCHAR(40) NOT NULL,  
      gender      ENUM('M','F','U') DEFAULT 'U',  
      birthday    DATE,                      
      role        ENUM('student','admin') DEFAULT 'student',
      myps        VARCHAR(500),                     -- 个人简介
      avatar      MEDIUMBLOB,													-- 头像
      FOREIGN KEY (user_id) REFERENCES user_auth(user_id)  -- 外键约束，确保用户ID的有效性
      ON DELETE CASCADE 
  );
  x
  -- 词汇资源表
  CREATE TABLE vocab (
      word_id     INT AUTO_INCREMENT PRIMARY KEY,
      word        VARCHAR(80) NOT NULL,        
      meaning     VARCHAR(255),         
      example     VARCHAR(255),                  
      level       ENUM('A1','A2','B1','B2','C1','C2') DEFAULT 'A1' 
  );

  -- 语法教程表
  CREATE TABLE grammar (
      grammar_id  INT AUTO_INCREMENT PRIMARY KEY, 
      title       VARCHAR(120) NOT NULL, 
      content     TEXT,               
      level       ENUM('A1','A2','B1','B2','C1','C2') DEFAULT 'A1'
  );

  -- 听力素材表
  CREATE TABLE listening (
      listen_id   INT AUTO_INCREMENT PRIMARY KEY,  
      title       VARCHAR(120) NOT NULL,      
      audio_url   VARCHAR(255) NOT NULL,
      transcript  TEXT,                
      level       ENUM('A1','A2','B1','B2','C1','C2') DEFAULT 'A1' 
  );

  -- 测验主表
  CREATE TABLE quiz (
      quiz_id     INT AUTO_INCREMENT PRIMARY KEY,
      quiz_type   ENUM('vocab','grammar','listening') NOT NULL, 
      title       VARCHAR(120) NOT NULL,         
      total_points INT NOT NULL DEFAULT 100       
  );

  -- 题库表
  CREATE TABLE quiz_question (
      question_id INT AUTO_INCREMENT PRIMARY KEY,
      quiz_id     INT NOT NULL,             
      question    TEXT,                 
      option_a    VARCHAR(255),       
      option_b    VARCHAR(255),          
      option_c    VARCHAR(255),    
      option_d    VARCHAR(255),             
      correct_opt CHAR(1),                      
      score       INT DEFAULT 1,                  
      FOREIGN KEY (quiz_id) REFERENCES quiz(quiz_id) ON DELETE CASCADE
  );

  -- 测验结果表
  CREATE TABLE quiz_result (
      result_id   INT AUTO_INCREMENT PRIMARY KEY,  
      user_id     INT NOT NULL,              
      quiz_id     INT NOT NULL,               
      score       INT,                  
      correct_cnt INT,                    
      total_cnt   INT,               
      taken_at    DATETIME DEFAULT CURRENT_TIMESTAMP, -- 测验时间自动记录
      FOREIGN KEY (user_id) REFERENCES user_auth(user_id), -- 用户外键约束
      FOREIGN KEY (quiz_id) REFERENCES quiz(quiz_id) -- 测验外键约束
  );

  -- 进度跟踪表 
  CREATE TABLE progress (
      user_id         INT PRIMARY KEY,             
      vocab_learned   INT DEFAULT 0,         
      grammar_learned INT DEFAULT 0,        
      listening_done  INT DEFAULT 0,             
      last_update     DATETIME DEFAULT CURRENT_TIMESTAMP, -- 最后更新时间
      FOREIGN KEY (user_id) REFERENCES user_auth(user_id) ON DELETE CASCADE -- 外键约束，同id用户删除
  );

  -- 帖子表
  CREATE TABLE post (
      post_id     INT AUTO_INCREMENT PRIMARY KEY, 
      user_id     INT NOT NULL,              
      title       VARCHAR(120),             
      content     TEXT,                           
      category    ENUM('general','question') DEFAULT 'general', 
      status      ENUM('pending','approved','rejected') DEFAULT 'pending',
      created_at  DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (user_id) REFERENCES user_auth(user_id)
  );

  -- 评论表
  CREATE TABLE comment (
      comment_id  INT AUTO_INCREMENT PRIMARY KEY, 
      post_id     INT NOT NULL,             
      user_id     INT NOT NULL,              
      content     TEXT,                     
      created_at  DATETIME DEFAULT CURRENT_TIMESTAMP, 
      FOREIGN KEY (post_id) REFERENCES post(post_id) ON DELETE CASCADE, -- 帖子外键约束级联删除
      FOREIGN KEY (user_id) REFERENCES user_auth(user_id) -- 用户外键约束
  );

```

---

# 存储过程 / 函数	

```sql
-- 加密函数：返回 SHA2(plain + salt)
DELIMITER $$
CREATE FUNCTION hash_password(p_plain VARCHAR(255), p_salt CHAR(16))
RETURNS CHAR(64) DETERMINISTIC
BEGIN
    RETURN UPPER(SHA2(CONCAT(p_plain, p_salt), 256));
END$$
DELIMITER ;

-- 计算准确率
DELIMITER $$
CREATE FUNCTION fn_calc_accuracy(p_correct INT, p_total INT)
RETURNS DECIMAL(5,2) DETERMINISTIC
BEGIN
    RETURN ROUND(p_correct / p_total * 100, 2);
END$$
DELIMITER ;

-- 	根据准确率返回等级
DELIMITER $$
CREATE FUNCTION fn_get_level(p_acc DECIMAL(5,2))
RETURNS VARCHAR(10) DETERMINISTIC
BEGIN
    RETURN CASE
        WHEN p_acc >= 90 THEN 'Excellent'
        WHEN p_acc >= 75 THEN 'Good'	
        WHEN p_acc >= 60 THEN 'Pass'
        ELSE 'Fail'
    END;
END$$
DELIMITER ;
```

```mongodb
var database = db.getSiblingDB('language_app_logs');

  database.createCollection('activity_logs', {
    validator: {
      $jsonSchema: {
        bsonType: 'object',
        required: ['user_id', 'nickname', 'action_type', 'timestamp', 'details'],
        properties: {
          user_id: {
            oneOf: [{ bsonType: 'int' }, { bsonType: 'long' }],
            description: '必须为整型（int32 或 int64）'
          },
          nickname: { bsonType: 'string', description: '必须为字符串' },
          action_type: { bsonType: 'string', description: '必须为字符串' },
          timestamp: { bsonType: 'date', description: '必须为日期类型' },
          details: { bsonType: 'object', description: '不固定结构的对象' }
        },
        additionalProperties: true
      }
    },
    validationLevel: 'moderate',
    validationAction: 'error'
  });

```



